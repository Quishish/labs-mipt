#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Пункт 11.  Зависимость коэффициента вязкого трения b
от положения нижнего груза r.
Анализируются 5 экспериментов ELP_xxx.TXT
"""

import numpy as np
import matplotlib.pyplot as plt
from pathlib import Path

# --------------------------  данные  --------------------------

# положение груза (см) – из условия задачи
r_cm = np.array([12.65, 15.85, 18.957, 22.1, 25.3])

# периоды линейных колебаний T0 (с) – рассчитаны в п.9
T0 = np.array([1.484268, 1.374836, 1.336012, 1.321739, 1.330762])
dT0 = 0.00086          # погрешность T0 (одинакова для всех)

# параметры затухания β – рассчитаны в п.10
beta = np.array([2.00, 1.74 , 1.61, 1.55, 1.52]) * 1e-3
#beta = np.array([1.90, 1.90 , 1.90, 1.90, 1.90]) * 1e-3
dbeta = 0.3 * 1e-3     # погрешность β

# ----------------------  физические константы  -----------------

g = 9.81               # ускорение свободного падения
m_shaft = 0.120        # масса стержня маятника (кг)
L = 0.30               # длина стержня (м)
m_add = 0.364         # масса подвижного груза (кг) – из п.9

# ----------------------  вспомогательные функции  -------------

def moment_of_inertia(r_m: float) -> float:
    """
    Момент инерции маятника с грузом на расстоянии r_m (м).
    Стержень – тонкий, масса груза << массы стержня.
    I = I_rod + m_add * r**2
    """
    I_rod = 0.01
    return I_rod + m_add * r_m**2

def omega0(T: float) -> float:
    """Угловая частота линейных колебаний (рад/с)."""
    return 2 * np.pi / T

def viscous_coeff(I: float, w0: float, beta: float) -> float:
    """Коэффициент вязкого трения b (кг·м²/с)."""
    return 2 * I * w0 * beta

# ----------------------  расчёты  ------------------------------

r_m = r_cm / 100                                   # в метрах
I = np.array([moment_of_inertia(r) for r in r_m])  # моменты инерции
w0 = omega0(T0)                                    # угловые частоты
b = viscous_coeff(I, w0, beta)                     # искомые коэффициенты

# погрешности
dw0 = 2 * np.pi * dT0 / T0**2
db = b * np.sqrt((dbeta/beta)**2 + (dw0/w0)**2 + (dT0/T0)**2)

# ----------------------  аппроксимация  ------------------------

# линейная аппроксимация b = k * r + c
k, c = np.polyfit(r_cm, b, 1)
b_fit = k * r_cm + c

# квадратичная аппроксимация b = a * r^2 + b * r + c
a2, b2, c2 = np.polyfit(r_cm, b, 2)
b_fit2 = a2 * r_cm**2 + b2 * r_cm + c2

# ----------------------  график  -------------------------------
fig, ax = plt.subplots(figsize=(6, 4))

ax.scatter(r_cm, b*1e3, label='Эксперимент')
ax.plot(r_cm, b_fit*1e3, '--', label=f'Линейная аппроксимация')
ax.plot(r_cm, b_fit2*1e3, '-',  label=f'Квадратичная аппроксимация')

ax.set_xlabel('Положение груза $r$, см', fontsize = 20)
ax.set_ylabel('Коэффициент вязкого трения $b$, мН·м·с', fontsize = 20)
ax.tick_params(axis='both', which='major', labelsize=14)
ax.tick_params(axis='both', which='minor', labelsize=12)
plt.grid(True, alpha=0.3)
ax.set_title('Зависимость $b(r)$', fontsize = 30)
ax.legend(fontsize=14)
ax.minorticks_on()
plt.tight_layout()
plt.show()

# ----------------------  вывод в консоль  ----------------------

print('Результаты расчёта коэффициента вязкого трения')
print(' r (см)   b (мН·м·с)  Δb (мН·м·с)')
print('-------------------------------------')
for ri, bi, dbi in zip(r_cm, b*1e3, db*1e3):
    print(f'{ri:6.2f}   {bi:8.3f}   {dbi:6.3f}')

print(f'\nЛинейная аппроксимация:  b = ({k*1e3:.3f}·r + {c*1e3:.3f}) мН·м·с')
print(f'Квадратичная аппроксимация: b = ({a2*1e3:.3f}·r² + {b2*1e3:.3f}·r + {c2*1e3:.3f}) мН·м·с')